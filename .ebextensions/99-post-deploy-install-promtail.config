files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_setup_promtail.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # 01_create_current_directory
      sudo mkdir -p /var/app/current
      sudo chown ec2-user:ec2-user /var/app/current
      sudo chmod 755 /var/app/current

      # 02_install_docker
      sudo amazon-linux-extras install -y docker
      sudo systemctl enable docker
      sudo systemctl start docker

      # 03_install_docker_compose
      sudo curl -L "https://github.com/docker/compose/releases/download/v2.5.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      sudo chmod +x /usr/local/bin/docker-compose
      docker-compose --version

      # 04_create_log_directories
      mkdir -p /var/app/current/logs/all
      mkdir -p /var/app/current/logs/warn
      mkdir -p /var/app/current/logs/error
      sudo chown -R ec2-user:ec2-user /var/app/current/logs
      sudo chmod -R 755 /var/app/current/logs

      # 05_create_promtail_config
      cat << EOF > /var/app/current/promtail-config.yml
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /var/app/current/positions.yaml

      clients:
        - url: ${LOKI_URL}

      scrape_configs:
        - job_name: all
          static_configs:
            - targets:
                - localhost
              labels:
                job: all_logs
                __path__: /var/app/current/logs/all/*.log

        - job_name: warn
          static_configs:
            - targets:
                - localhost
              labels:
                job: warn_logs
                __path__: /var/app/current/logs/warn/*.log

        - job_name: error
          static_configs:
            - targets:
                - localhost
              labels:
                job: error_logs
                __path__: /var/app/current/logs/error/*.log
      EOF

      # 06_setup_promtail
      echo "{}" > /var/app/current/positions.yaml

      cat << EOF > /var/app/current/promtail-docker-compose.yml
      version: '3'
      services:
        promtail:
          image: grafana/promtail:2.5.0
          environment:
            - LOKI_URL=${LOKI_URL}
          ports:
            - "9080:9080"
          volumes:
            - /var/app/current/positions.yaml:/var/app/current/positions.yaml
            - /var/app/current:/var/app/current
          command: -config.file=/var/app/current/promtail-config.yml
      EOF

      docker-compose -f /var/app/current/promtail-docker-compose.yml up -d

container_commands:
  01_set_permissions:
    command: "chmod +x /opt/elasticbeanstalk/hooks/appdeploy/post/99_setup_promtail.sh"