container_commands:
  01_create_current_directory:
    command: |
      # /var/app/current 디렉토리 생성 및 권한 설정
      sudo mkdir -p /var/app/current
      sudo chmod -R 777 /var/app/current

  02_install_docker:
    command: |
      if ! command -v docker &> /dev/null; then
        curl -fsSL https://get.docker.com -o get-docker.sh
        sh get-docker.sh
      fi

  03_install_docker_compose:
    command: |
      curl -L "https://github.com/docker/compose/releases/download/v2.5.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      chmod +x /usr/local/bin/docker-compose

  04_setup_promtail:
    command: |
      set -ex
      # Promtail Docker Compose 설정 파일 생성
      echo "version: '3'
      services:
        promtail:
          image: grafana/promtail:2.5.0
          volumes:
            - /var/log:/var/log
            - /tmp/positions.yaml:/tmp/positions.yaml
            - /etc/app/current:/etc/app/current
          command: -config.file=/etc/app/current/promtail-config.yml" > /var/app/current/promtail-docker-compose.yml

      # Docker Compose 실행
      docker-compose -f /var/app/current/promtail-docker-compose.yml up -d
