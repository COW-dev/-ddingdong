files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_start_promtail.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      # Promtail 설치
      if [ ! -f /usr/local/bin/promtail ]; then
        curl -O -L "https://github.com/grafana/loki/releases/download/v2.8.0/promtail-linux-amd64.zip"
        unzip promtail-linux-amd64.zip
        sudo mv promtail-linux-amd64 /usr/local/bin/promtail
        rm promtail-linux-amd64.zip
      fi

      # Promtail 설정 파일 생성
      cat > /etc/promtail-config.yaml << EOL
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /tmp/positions.yaml

      clients:
        - url: ${LOKI_URL}

      scrape_configs:
        - job_name: all
          static_configs:
            - targets:
                - localhost
              labels:
                job: all_logs
                __path__: /var/app/current/logs/all/*.log

        - job_name: warn
          static_configs:
            - targets:
                - localhost
              labels:
                job: warn_logs
                __path__: /var/app/current/logs/warn/*.log

        - job_name: error
          static_configs:
            - targets:
                - localhost
              labels:
                job: error_logs
                __path__: /var/app/current/logs/error/*.log
      EOL

      # Promtail 서비스 파일 생성
      cat > /etc/systemd/system/promtail.service << EOL
      [Unit]
      Description=Promtail service
      After=network.target

      [Service]
      Type=simple
      User=webapp
      EnvironmentFile=/opt/elasticbeanstalk/deployment/env
      ExecStart=/usr/local/bin/promtail -config.file /etc/promtail-config.yaml
      Restart=always

      [Install]
      WantedBy=multi-user.target
      EOL

      # 로그 디렉토리 권한 설정
      sudo mkdir -p /var/app/current/logs/all /var/app/current/logs/warn /var/app/current/logs/error
      sudo chown -R webapp:webapp /var/app/current/logs

      # Promtail 서비스 시작
      sudo systemctl daemon-reload
      sudo systemctl enable promtail
      sudo systemctl start promtail

commands:
  01_install_unzip:
    command: "yum install -y unzip"
