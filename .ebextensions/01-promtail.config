container_commands:
  01_install_promtail:
    command: |
      # Install Docker (if not already installed)
      if ! [ -x "$(command -v docker)" ]; then
        yum update -y
        amazon-linux-extras install docker
        service docker start
        usermod -a -G docker ec2-user
      fi

      # Install Docker Compose (if not already installed)
      if ! [ -x "$(command -v docker-compose)" ]; then
        curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
      fi

      # Pull the latest Promtail image and run it with Docker Compose
      cd /var/app/current
      docker-compose -f promtail-docker-compose.yml down || true
      docker-compose -f promtail-docker-compose.yml up -d
